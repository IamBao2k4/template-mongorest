{
  "_id": "67848a582669d501febe379a",
  "title": "is-user-has-permission-manage-group-reports (not need group id)",
  "note": "",
  "entity": [
    "6747ef07c47463d88f8c5ab1"
  ],
  "advance": "[\n  {\n    \"$match\": {\n      \"_id\": { \"$exists\": false }\n    }\n  },\n  {\n    \"$unionWith\": {\n      \"coll\": \"mge-tweet-social-image\",\n      \"pipeline\": [\n        {\n          \"$addFields\": {\n            \"type\": \"social-images\"\n          }\n        }\n      ]\n    }\n  },\n  {\n    \"$unionWith\": {\n      \"coll\": \"mge-tweet-social-videos\",\n      \"pipeline\": [\n        {\n          \"$addFields\": {\n            \"type\": \"videos\"\n          }\n        }\n      ]\n    }\n  },\n  {\n    \"$unionWith\": {\n      \"coll\": \"mge-tweet-social-news\",\n      \"pipeline\": [\n        {\n          \"$addFields\": {\n            \"type\": \"social-news\"\n          }\n        }\n      ]\n    }\n  },\n  {\n    \"$unionWith\": {\n      \"coll\": \"mge-tweet-comment\",\n      \"pipeline\": [\n        {\n          \"$addFields\": {\n            \"type\": \"comment\"\n          }\n        }\n      ]\n    }\n  },\n  {\n    \"$addFields\": {\n      \"document_id\": {\n        \"$toString\": \"$_id\"\n      }\n    }\n  },\n  {\n    \"$lookup\": {\n      \"from\": \"mge-user-reports\",\n      \"localField\": \"document_id\",\n      \"foreignField\": \"document_id\",\n      \"pipeline\": [\n        {\n          \"$addFields\": {\n            \"_id\": {\n              \"$toString\": \"$_id\"\n            }\n          }\n        },\n        {\n          \"$match\": {\n            \"_id\": \"@param:_id\"\n          }\n        }\n      ],\n      \"as\": \"report_info\"\n    }\n  },\n  {\n    \"$match\": {\n      \"report_info\": { \"$ne\": [] }\n    }\n  },\n  {\n    \"$lookup\": {\n      \"from\": \"mge-group-member\",\n      \"localField\": \"social_group\",\n      \"foreignField\": \"social_group\",\n      \"pipeline\": [\n        {\n          \"$match\": {\n            \"user\": \"@jwt:user.id\",\n            \"status\": \"joined\"\n          }\n        }\n      ],\n      \"as\": \"memberStatus\"\n    }\n  },\n  {\n    \"$addFields\": {\n      \"social_group\": {\n        \"$map\": {\n          \"input\": \"$social_group\",\n          \"as\": \"sg\",\n          \"in\": {\n            \"$toObjectId\": \"$$sg\"\n          }\n        }\n      }\n    }\n  },\n  {\n    \"$lookup\": {\n      \"from\": \"mge-group\",\n      \"localField\": \"social_group\",\n      \"foreignField\": \"_id\",\n      \"as\": \"group_info\"\n    }\n  },\n  {\n    \"$addFields\": {\n      \"memberStatus\": {\n        \"$arrayElemAt\": [\"$memberStatus\", 0]\n      }\n    }\n  },\n  {\n    \"$addFields\": {\n      \"group_info_permissions_match\": {\n        \"$map\": {\n          \"input\": \"$group_info\",\n          \"as\": \"group\",\n          \"in\": {\n            \"$or\": [\n              {\n                \"$and\": [\n                  { \"$isArray\": \"$$group.permissions.group_reports_manage\" },\n                  { \"$in\": [\"$memberStatus.role\", \"$$group.permissions.group_reports_manage\"] }\n                ]\n              },\n              {\n                \"$and\": [\n                  { \"$not\": { \"$isArray\": \"$$group.permissions.group_reports_manage\" } },\n                  { \"$eq\": [\"$memberStatus.role\", \"$$group.permissions.group_reports_manage\"] }\n                ]\n              }\n            ]\n          }\n        }\n      }\n    }\n  },\n  {\n    \"$match\": {\n      \"group_info_permissions_match\": { \"$elemMatch\": { \"$eq\": true } }\n    }\n  }\n]",
  "locale": null,
  "locale_id": null,
  "tenant_id": "674028d2611a654e763a73e8"
}