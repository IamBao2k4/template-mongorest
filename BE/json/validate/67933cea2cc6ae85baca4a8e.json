{
  "_id": "67933cea2cc6ae85baca4a8e",
  "title": "is-user-has-permission-to-manage-discussion (through discussion_comment)",
  "note": "",
  "entity": [
    "6752c64565017d942f759585"
  ],
  "tenant_id": "677f6b3da3131eb0d3f9906d",
  "advance": "[\n  {\n    \"$addFields\": {\n      \"_id\": {\n        \"$toString\": \"$_id\"\n      }\n    }\n  },\n  {\n    \"$match\": {\n      \"_id\":\"@param:_id\"\n    }\n  },\n  {\n    \"$addFields\": {\n      \"discussion\": {\n        \"$map\": {\n          \"input\": \"$discussion\",\n          \"as\": \"sg\",\n          \"in\": {\n            \"$toObjectId\": \"$$sg\"\n          }\n        }\n      }\n    }\n  },\n  {\n    \"$lookup\": {\n      \"from\": \"mge-discussions\",\n      \"localField\": \"discussion\",\n      \"foreignField\": \"_id\",\n      \"as\": \"discussion_info\"\n    }\n  },\n  {\n    \"$lookup\": {\n      \"from\": \"mge-course-member\",\n      \"localField\": \"discussion_info.course\",\n      \"foreignField\": \"course\",\n      \"pipeline\": [\n        {\n          \"$match\": {\n            \"user\": \"@jwt:user.id\",\n            \"status\":\"joined\"\n          }\n        },\n            {\n    \"$addFields\": {\n      \"course\": {\n        \"$map\": {\n          \"input\": \"$course\",\n          \"as\": \"sg\",\n          \"in\": {\n            \"$toObjectId\": \"$$sg\"\n          }\n        }\n      }\n    }\n  }\n      ],\n      \"as\": \"memberStatus\"\n    }\n  },\n  {\n    \"$lookup\": {\n      \"from\": \"mge-courses\",\n      \"localField\": \"memberStatus.course\",\n      \"foreignField\": \"_id\",\n      \"as\": \"course_info\"\n    }\n  },\n  {\n    \"$addFields\": {\n      \"course_info\": { \"$arrayElemAt\": [\"$course_info\", 0] }\n    }\n  },\n  {\n    \"$addFields\": {\n      \"memberStatus\": { \"$arrayElemAt\": [\"$memberStatus\", 0] }\n    }\n  },\n  {\n    \"$addFields\": {\n      \"can_manage_discussion_in_course\": {\n        \"$in\": [\n          \"$memberStatus.role\", \n          \"$course_info.permissions.course_discussion_manage\"\n        ]\n      }\n    }\n  },\n  {\n    \"$match\": {\n      \"can_manage_discussion_in_course\": true\n    }\n  }\n]"
}