{
  "_id": "6822a5081d50e98cb4b467e3",
  "title": "get detail user's course tenant statistic",
  "note": "",
  "cache_time": "",
  "method": "get-detail",
  "outputEntity": [
    "67aad740a67aaa1951ca64b0"
  ],
  "categories": [],
  "queryAdvance": "[\r\n  {\r\n    \"$match\": {\r\n      \"user\": \"@jwt:user.id\",\r\n      \"tenant_id\": \"@header:x-tenant-id\"\r\n    }\r\n  },\r\n  {\r\n    \"$lookup\": {\r\n      \"from\": \"mge-course-member\",\r\n      \"localField\": \"user\",\r\n      \"foreignField\": \"user\",\r\n      \"pipeline\": [\r\n        {\r\n          \"$match\": {\r\n            \"tenant_id\": \"@header:x-tenant-id\",\r\n            \"status\": \"joined\"\r\n          }\r\n        },\r\n        {\r\n          \"$match\": {\r\n            \"$expr\": {\r\n              \"$and\": [\r\n                {\r\n                  \"$or\": [\r\n                    {\r\n                      \"$and\": [\r\n                        {\r\n                          \"$ne\": [\r\n                            \"@param:start_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$ne\": [\r\n                            \"@param:end_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$and\": [\r\n                            {\r\n                              \"$gte\": [\r\n                                \"$created_at\",\r\n                                {\r\n                                  \"$toDate\": \"@param:start_date\"\r\n                                }\r\n                              ]\r\n                            },\r\n                            {\r\n                              \"$lte\": [\r\n                                \"$created_at\",\r\n                                {\r\n                                  \"$toDate\": \"@param:end_date\"\r\n                                }\r\n                              ]\r\n                            }\r\n                          ]\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"$or\": [\r\n                        {\r\n                          \"$eq\": [\r\n                            \"@param:start_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$eq\": [\r\n                            \"@param:end_date\",\r\n                            null\r\n                          ]\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"as\": \"course_joined\"\r\n    }\r\n  },\r\n  {\r\n    \"$addFields\": {\r\n      \"total_course\": {\r\n        \"$size\": \"$course_joined\"\r\n      }\r\n    }\r\n  },\r\n  {\r\n    \"$lookup\": {\r\n      \"from\": \"mge-course-member\",\r\n      \"localField\": \"user\",\r\n      \"foreignField\": \"user\",\r\n      \"pipeline\": [\r\n        {\r\n          \"$match\": {\r\n            \"tenant_id\": \"@header:x-tenant-id\",\r\n            \"status\": \"joined\"\r\n          }\r\n        }\r\n      ],\r\n      \"as\": \"all_course_joined\"\r\n    }\r\n  },\r\n  {\r\n    \"$addFields\": {\r\n      \"all_course_joined\": {\r\n        \"$size\": \"$all_course_joined\"\r\n      }\r\n    }\r\n  },\r\n  {\r\n    \"$lookup\": {\r\n      \"from\": \"mge-course-member\",\r\n      \"localField\": \"user\",\r\n      \"foreignField\": \"created_by\",\r\n      \"pipeline\": [\r\n        {\r\n          \"$match\": {\r\n            \"tenant_id\": \"@header:x-tenant-id\",\r\n            \"status\": \"joined\",\r\n            \"is_finished\": true\r\n          }\r\n        },\r\n        {\r\n          \"$match\": {\r\n            \"$expr\": {\r\n              \"$and\": [\r\n                {\r\n                  \"$or\": [\r\n                    {\r\n                      \"$and\": [\r\n                        {\r\n                          \"$ne\": [\r\n                            \"@param:start_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$ne\": [\r\n                            \"@param:end_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$and\": [\r\n                            {\r\n                              \"$gte\": [\r\n                                \"$created_at\",\r\n                                {\r\n                                  \"$toDate\": \"@param:start_date\"\r\n                                }\r\n                              ]\r\n                            },\r\n                            {\r\n                              \"$lte\": [\r\n                                \"$created_at\",\r\n                                {\r\n                                  \"$toDate\": \"@param:end_date\"\r\n                                }\r\n                              ]\r\n                            }\r\n                          ]\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"$or\": [\r\n                        {\r\n                          \"$eq\": [\r\n                            \"@param:start_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$eq\": [\r\n                            \"@param:end_date\",\r\n                            null\r\n                          ]\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"as\": \"is_course_finished\"\r\n    }\r\n  },\r\n  {\r\n    \"$addFields\": {\r\n      \"total_course_finished\": {\r\n        \"$size\": \"$is_course_finished\"\r\n      }\r\n    }\r\n  },\r\n  {\r\n    \"$addFields\": {\r\n      \"avg_completion_rate\": {\r\n        \"$multiply\": [\r\n          {\r\n            \"$divide\": [\r\n              \"$total_course_finished\",\r\n              \"$all_course_joined\"\r\n            ]\r\n          },\r\n          100\r\n        ]\r\n      }\r\n    }\r\n  },\r\n  {\r\n    \"$lookup\": {\r\n      \"from\": \"mge-discussions\",\r\n      \"localField\": \"user\",\r\n      \"foreignField\": \"created_by\",\r\n      \"pipeline\": [\r\n        {\r\n          \"$match\": {\r\n            \"tenant_id\": \"@header:x-tenant-id\"\r\n          }\r\n        },\r\n        {\r\n          \"$match\": {\r\n            \"$expr\": {\r\n              \"$and\": [\r\n                {\r\n                  \"$or\": [\r\n                    {\r\n                      \"$and\": [\r\n                        {\r\n                          \"$ne\": [\r\n                            \"@param:start_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$ne\": [\r\n                            \"@param:end_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$and\": [\r\n                            {\r\n                              \"$gte\": [\r\n                                \"$created_at\",\r\n                                {\r\n                                  \"$toDate\": \"@param:start_date\"\r\n                                }\r\n                              ]\r\n                            },\r\n                            {\r\n                              \"$lte\": [\r\n                                \"$created_at\",\r\n                                {\r\n                                  \"$toDate\": \"@param:end_date\"\r\n                                }\r\n                              ]\r\n                            }\r\n                          ]\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"$or\": [\r\n                        {\r\n                          \"$eq\": [\r\n                            \"@param:start_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$eq\": [\r\n                            \"@param:end_date\",\r\n                            null\r\n                          ]\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"as\": \"total_discussions\"\r\n    }\r\n  },\r\n  {\r\n    \"$addFields\": {\r\n      \"total_discussions\": {\r\n        \"$size\": \"$total_discussions\"\r\n      }\r\n    }\r\n  },\r\n  {\r\n    \"$lookup\": {\r\n      \"from\": \"mge-discussion-comment\",\r\n      \"localField\": \"user\",\r\n      \"foreignField\": \"created_by\",\r\n      \"pipeline\": [\r\n        {\r\n          \"$match\": {\r\n            \"tenant_id\": \"@header:x-tenant-id\"\r\n          }\r\n        },\r\n        {\r\n          \"$match\": {\r\n            \"$expr\": {\r\n              \"$and\": [\r\n                {\r\n                  \"$or\": [\r\n                    {\r\n                      \"$and\": [\r\n                        {\r\n                          \"$ne\": [\r\n                            \"@param:start_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$ne\": [\r\n                            \"@param:end_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$and\": [\r\n                            {\r\n                              \"$gte\": [\r\n                                \"$created_at\",\r\n                                {\r\n                                  \"$toDate\": \"@param:start_date\"\r\n                                }\r\n                              ]\r\n                            },\r\n                            {\r\n                              \"$lte\": [\r\n                                \"$created_at\",\r\n                                {\r\n                                  \"$toDate\": \"@param:end_date\"\r\n                                }\r\n                              ]\r\n                            }\r\n                          ]\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"$or\": [\r\n                        {\r\n                          \"$eq\": [\r\n                            \"@param:start_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$eq\": [\r\n                            \"@param:end_date\",\r\n                            null\r\n                          ]\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"as\": \"total_comments\"\r\n    }\r\n  },\r\n  {\r\n    \"$addFields\": {\r\n      \"total_comments\": {\r\n        \"$size\": \"$total_comments\"\r\n      }\r\n    }\r\n  },\r\n  {\r\n    \"$lookup\": {\r\n      \"from\": \"mge-discussion-like\",\r\n      \"localField\": \"user\",\r\n      \"foreignField\": \"created_by\",\r\n      \"pipeline\": [\r\n        {\r\n          \"$match\": {\r\n            \"tenant_id\": \"@header:x-tenant-id\"\r\n          }\r\n        },\r\n        {\r\n          \"$match\": {\r\n            \"$expr\": {\r\n              \"$and\": [\r\n                {\r\n                  \"$or\": [\r\n                    {\r\n                      \"$and\": [\r\n                        {\r\n                          \"$ne\": [\r\n                            \"@param:start_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$ne\": [\r\n                            \"@param:end_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$and\": [\r\n                            {\r\n                              \"$gte\": [\r\n                                \"$created_at\",\r\n                                {\r\n                                  \"$toDate\": \"@param:start_date\"\r\n                                }\r\n                              ]\r\n                            },\r\n                            {\r\n                              \"$lte\": [\r\n                                \"$created_at\",\r\n                                {\r\n                                  \"$toDate\": \"@param:end_date\"\r\n                                }\r\n                              ]\r\n                            }\r\n                          ]\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"$or\": [\r\n                        {\r\n                          \"$eq\": [\r\n                            \"@param:start_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$eq\": [\r\n                            \"@param:end_date\",\r\n                            null\r\n                          ]\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"as\": \"discussion_liked\"\r\n    }\r\n  },\r\n  {\r\n    \"$addFields\": {\r\n      \"discussion_liked\": {\r\n        \"$size\": \"$discussion_liked\"\r\n      }\r\n    }\r\n  },\r\n  {\r\n    \"$lookup\": {\r\n      \"from\": \"mge-discussion-comment-like\",\r\n      \"localField\": \"user\",\r\n      \"foreignField\": \"created_by\",\r\n      \"pipeline\": [\r\n        {\r\n          \"$match\": {\r\n            \"tenant_id\": \"@header:x-tenant-id\"\r\n          }\r\n        },\r\n        {\r\n          \"$match\": {\r\n            \"$expr\": {\r\n              \"$and\": [\r\n                {\r\n                  \"$or\": [\r\n                    {\r\n                      \"$and\": [\r\n                        {\r\n                          \"$ne\": [\r\n                            \"@param:start_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$ne\": [\r\n                            \"@param:end_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$and\": [\r\n                            {\r\n                              \"$gte\": [\r\n                                \"$created_at\",\r\n                                {\r\n                                  \"$toDate\": \"@param:start_date\"\r\n                                }\r\n                              ]\r\n                            },\r\n                            {\r\n                              \"$lte\": [\r\n                                \"$created_at\",\r\n                                {\r\n                                  \"$toDate\": \"@param:end_date\"\r\n                                }\r\n                              ]\r\n                            }\r\n                          ]\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"$or\": [\r\n                        {\r\n                          \"$eq\": [\r\n                            \"@param:start_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$eq\": [\r\n                            \"@param:end_date\",\r\n                            null\r\n                          ]\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"as\": \"discussion_comment_liked\"\r\n    }\r\n  },\r\n  {\r\n    \"$addFields\": {\r\n      \"discussion_comment_liked\": {\r\n        \"$size\": \"$discussion_comment_liked\"\r\n      }\r\n    }\r\n  },\r\n  {\r\n    \"$addFields\": {\r\n      \"total_likes\": {\r\n        \"$add\": [\r\n          \"$discussion_liked\",\r\n          \"$discussion_comment_liked\"\r\n        ]\r\n      }\r\n    }\r\n  },\r\n  {\r\n    \"$addFields\": {\r\n      \"interaction_score\": {\r\n        \"$add\": [\r\n          {\r\n            \"$multiply\": [\r\n              \"$total_discussions\",\r\n              5\r\n            ]\r\n          },\r\n          {\r\n            \"$multiply\": [\r\n              \"$total_comments\",\r\n              3\r\n            ]\r\n          },\r\n          {\r\n            \"$multiply\": [\r\n              \"$total_likes\",\r\n              1\r\n            ]\r\n          }\r\n        ]\r\n      }\r\n    }\r\n  },\r\n  {\r\n    \"$lookup\": {\r\n      \"from\": \"mge-user-learning-path\",\r\n      \"localField\": \"user\",\r\n      \"foreignField\": \"user\",\r\n      \"pipeline\": [\r\n        {\r\n          \"$match\": {\r\n            \"tenant_id\": \"@header:x-tenant-id\"\r\n          }\r\n        },\r\n        {\r\n          \"$match\": {\r\n            \"$expr\": {\r\n              \"$and\": [\r\n                {\r\n                  \"$or\": [\r\n                    {\r\n                      \"$and\": [\r\n                        {\r\n                          \"$ne\": [\r\n                            \"@param:start_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$ne\": [\r\n                            \"@param:end_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$and\": [\r\n                            {\r\n                              \"$gte\": [\r\n                                \"$created_at\",\r\n                                {\r\n                                  \"$toDate\": \"@param:start_date\"\r\n                                }\r\n                              ]\r\n                            },\r\n                            {\r\n                              \"$lte\": [\r\n                                \"$created_at\",\r\n                                {\r\n                                  \"$toDate\": \"@param:end_date\"\r\n                                }\r\n                              ]\r\n                            }\r\n                          ]\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"$or\": [\r\n                        {\r\n                          \"$eq\": [\r\n                            \"@param:start_date\",\r\n                            null\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"$eq\": [\r\n                            \"@param:end_date\",\r\n                            null\r\n                          ]\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"as\": \"total_learning_paths\"\r\n    }\r\n  },\r\n  {\r\n    \"$addFields\": {\r\n      \"total_learning_paths\": {\r\n        \"$size\": \"$total_learning_paths\"\r\n      }\r\n    }\r\n  },\r\n  {\r\n    \"$project\": {\r\n      \"user._id\": {\r\n        \"$first\": \"$user\"\r\n      },\r\n      \"user.email\": \"$email\",\r\n      \"user.full_name\": {\r\n        \"$concat\": [\r\n          {\r\n            \"$ifNull\": [\r\n              \"$profile.last_name\",\r\n              \"\"\r\n            ]\r\n          },\r\n          \" \",\r\n          {\r\n            \"$ifNull\": [\r\n              \"$profile.first_name\",\r\n              \"\"\r\n            ]\r\n          }\r\n        ]\r\n      },\r\n      \"user.featured_image\": \"$profile.course.featured_image\",\r\n      \"user.cover\": \"$profile.course.cover\",\r\n      \"user.birthday\": \"$profile.course.birthday\",\r\n      \"user.description\": \"$profile.course.description\",\r\n      \"user.department\": \"$profile.course.department\",\r\n      \"user.team\": \"$profile.course.team\",\r\n      \"user.job_position\": \"$profile.course.job_position\",\r\n      \"total_course\": 1,\r\n      \"avg_completion_rate\": 1,\r\n      \"pass_rate\": 1,\r\n      \"total_discussions\": 1,\r\n      \"total_comments\": 1,\r\n      \"total_likes\": 1,\r\n      \"interaction_score\": 1,\r\n      \"total_learning_paths\": 1\r\n    }\r\n  }\r\n]",
  "restricted": [
    {
      "key": "email",
      "value": "email"
    },
    {
      "key": "user",
      "value": "user"
    },
    {
      "key": "_id",
      "value": "_id"
    },
    {
      "key": "created_by",
      "value": "created_by"
    },
    {
      "key": "updated_by",
      "value": "updated_by"
    },
    {
      "key": "created_at",
      "value": "created_at"
    },
    {
      "key": "updated_at",
      "value": "updated_at"
    }
  ],
  "tenant_id": "677f6b3da3131eb0d3f9906d",
  "id": "6822a5081d50e98cb4b467e3"
}